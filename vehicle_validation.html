<script>
$(document).ready(function () {
  "use strict";

  // Enable multiple file uploads
  $("input[type=file]").attr("multiple", "multiple");

  // Initially hide all error messages and remove error classes
  $('[wr-type="error"]').hide();
  $('[wr-type="required-field"]').removeClass("error");

  // Helper functions for error handling
  function fieldError($field) {
    $field.addClass("error");
    $field.siblings('[wr-type="error"]').show();
  }

  function clearFieldError($field) {
    $field.removeClass("error");
    $field.siblings('[wr-type="error"]').hide();
  }

  // Initialize Flatpickr for Step 1 (date range) on the input with id "dates"
  var fp1 = flatpickr("#dates", {
    minDate: "today",
    mode: "range"
  });

  // Initialize Flatpickr for Step 3 (pickup/drop-off date)
  // Assumes that the second date picker has the id "pickup-dropoff-date"
  var fp2 = flatpickr("#pickup-dropoff-date", {
    minDate: "today",
    mode: "range"
  });

  // ---------------------------
  // STEP 1: Date Range Selection
  // ---------------------------
  function validateStep1(e) {
    if (!$("#dates").val()) {
      e.preventDefault();
      fieldError($("#dates"));
      return false;
    } else {
      clearFieldError($("#dates"));
      return true;
    }
  }

  // ---------------------------
  // STEP 2: Driver Option & Driving License Uploads
  // ---------------------------
  // Set default selection: With Driver is checked, Self Drive unchecked.
  $("#with-driver").prop("checked", true);
  $("#self-drive").prop("checked", false);

  // Toggle license upload fields based on the Self Drive option
  function toggleLicenseDetails() {
    if ($("#self-drive").is(":checked")) {
      // When Self Drive is selected, uncheck With Driver and show file upload sections.
      $("#with-driver").prop("checked", false);
      $("#license-details-front, #license-details-back").show();
    } else {
      // When With Driver is reselected, ensure it is checked and hide file upload sections.
      $("#with-driver").prop("checked", true).prop("disabled", false);
      $("#license-details-front, #license-details-back").hide();
      // Clear any file upload error messages
      clearFieldError($("#Driving-License-Front"));
      clearFieldError($("#Driving-License-Back"));
    }
  }
  $("#with-driver, #self-drive").on("change", toggleLicenseDetails);

  function validateStep2(e) {
    var valid = true;

    // Ensure at least one option is selected
    if (!$("#with-driver").is(":checked") && !$("#self-drive").is(":checked")) {
      e.preventDefault();
      fieldError($("#with-driver"));
      fieldError($("#self-drive"));
      valid = false;
    } else {
      clearFieldError($("#with-driver"));
      clearFieldError($("#self-drive"));
    }

    // If Self Drive is selected, require both driving license file uploads
    if ($("#self-drive").is(":checked")) {
      if ($("#Driving-License-Front")[0].files.length === 0) {
        e.preventDefault();
        fieldError($("#Driving-License-Front"));
        valid = false;
      } else {
        clearFieldError($("#Driving-License-Front"));
      }

      if ($("#Driving-License-Back")[0].files.length === 0) {
        e.preventDefault();
        fieldError($("#Driving-License-Back"));
        valid = false;
      } else {
        clearFieldError($("#Driving-License-Back"));
      }
    }
    return valid;
  }

  // ---------------------------
  // STEP 3: Airport Pickup Details
  // ---------------------------
  function validateStep3(e) {
    if ($("#airport-pickup").is(":checked")) {
      var valid = true;
      if (!$("#flight-number").val()) {
        e.preventDefault();
        fieldError($("#flight-number"));
        valid = false;
      } else {
        clearFieldError($("#flight-number"));
      }

      if (!$("#flight-time").val()) {
        e.preventDefault();
        fieldError($("#flight-time"));
        valid = false;
      } else {
        clearFieldError($("#flight-time"));
      }

      if (!$("#pickup-dropoff-date").val()) {
        e.preventDefault();
        fieldError($("#pickup-dropoff-date"));
        valid = false;
      } else {
        clearFieldError($("#pickup-dropoff-date"));
      }
      return valid;
    }
    return true;
  }

  // ---------------------------
  // STEP 4: Out-Of-Accra Region Selection
  // ---------------------------
  function validateStep4(e) {
    if ($("#Out-Of-Accra").is(":checked")) {
      // At least one region (checkbox with name 'location-checkbox') must be selected.
      if ($("input[name='location-checkbox']:checked").length === 0) {
        e.preventDefault();
        // For error display purposes, assume the container has a sibling error element.
        fieldError($("#location-details"));
        return false;
      } else {
        clearFieldError($("#location-details"));
      }
    }
    return true;
  }

  // ---------------------------
  // FINAL STEP: Identity Upload Validation
  // ---------------------------
  function validateFinal(e) {
    var valid = true;
    if ($("#id-upload-front")[0].files.length === 0) {
      e.preventDefault();
      fieldError($("#id-upload-front"));
      valid = false;
    } else {
      clearFieldError($("#id-upload-front"));
    }
    if ($("#id-upload-back")[0].files.length === 0) {
      e.preventDefault();
      fieldError($("#id-upload-back"));
      valid = false;
    } else {
      clearFieldError($("#id-upload-back"));
    }
    return valid;
  }

  // ---------------------------
  // Attach Validation Handlers to Step Navigation Buttons
  // ---------------------------
  // Step 1: Date selection "Next" button (assumed id "slider-1")
  $("#slider-1").on("click", function (e) {
    if (validateStep1(e)) {
      Webflow.push(function () {
        // Code to navigate to the next step if using Webflow interactions.
      });
    }
  });

  // Step 2: Driver option "Next" button (assumed id "slider-2")
  $("#slider-2").on("click", function (e) {
    if (validateStep2(e)) {
      Webflow.push(function () {
        // Code to navigate to the next step.
      });
    }
  });

  // Step 3: Airport pickup details "Next" button (assumed id "slider-3")
  $("#slider-3").on("click", function (e) {
    if (validateStep3(e)) {
      Webflow.push(function () {
        // Code to navigate to the next step.
      });
    }
  });

  // Step 4: Region selection "Next" button (assumed id "slider-4")
  $("#slider-4").on("click", function (e) {
    if (validateStep4(e)) {
      Webflow.push(function () {
        // Code to navigate to the final step.
      });
    }
  });

  // Final submission: Validate all steps before form submission
  $('[wr-type="submit"]').on("click", function (e) {
    var valid = true;
    if (!validateStep1(e)) valid = false;
    if (!validateStep2(e)) valid = false;
    if (!validateStep3(e)) valid = false;
    if (!validateStep4(e)) valid = false;
    if (!validateFinal(e)) valid = false;

    if (valid) {
      $(this).closest("form").submit();
    }
  });

  // ---------------------------
  // Clear Errors on User Interaction
  // ---------------------------
  $('[wr-type="required-field"]').on("keypress blur change", function () {
    clearFieldError($(this));
  });
  $("input[type=file]").on("change", function () {
    clearFieldError($(this));
  });

  // ---------------------------
  // Show/Hide Customization Based on Selections
  // ---------------------------
  // Out-Of-Accra region details: Show/hide container with id "location-details"
  $("#Out-Of-Accra").on("click", function () {
    $("#location-details").toggle(this.checked);
  });

  // Airport pickup details: Show/hide container with id "airportpick-details"
  $("#airport-pickup").on("click", function () {
    $("#airportpick-details").toggle(this.checked);
  });

  // Ensure self-drive license details visibility is set correctly on page load
  $(window).on("load", function () {
    $("#location-details").hide();
    $("#airportpick-details").hide();
    if (!$("#self-drive").is(":checked")) {
      $("#license-details-front, #license-details-back").hide();
    }
  });

  // ---------------------------
  // Additional Feature: Search for Out-of-Accra Regions
  // ---------------------------
  $(".on-page-search").on("keyup", function () {
    var v = $(this).val();
    $(".search-result").each(function () {
      var $this = $(this);
      if (v !== "" && $this.text().search(new RegExp(v, "gi")) !== -1) {
        $this.addClass("results").removeClass("noresults");
      } else if (v !== "" && $this.text().search(v) === -1) {
        $this.addClass("noresults").removeClass("results");
      } else {
        $this.removeClass("results noresults");
      }
    });
  });

  // ---------------------------
  // Populate Model Fields and Page URL on Window Load
  // ---------------------------
  $(window).on("load", function () {
    var model = $("#make").text();
    var carName = $("#car-name").text();
    var modelInfo = model + " " + carName;
    $("[id^='Vehicle-Model-Number']").each(function () {
      $(this).val(modelInfo);
    });
    $("#page-name").val(window.location.href);
  });
});

// Integrate Webflow.push for additional UI behavior if needed.
Webflow.push(function () {
  // Additional Webflow-specific code can be added here.
});
</script>
