<script>
  $(document).ready(function () {
    "use strict";

    // Enable multiple file uploads
    $("input[type=file]").attr("multiple", "multiple");

    // Hide all error messages initially and remove error classes
    $('[wr-type="error"]').hide();
    $('[wr-type="required-field"]').removeClass("error");

    var formErrors = false;

    // Utility function to display error state for a field.
    function fieldError($field) {
      $field.siblings('[wr-type="error"]').show();
      $field.addClass("error");
      formErrors = true;
    }

    // Utility function to clear error state for a field.
    function clearFieldError($field) {
      $field.removeClass("error");
      $field.siblings('[wr-type="error"]').hide();
    }

    // Handle general form submission when a submit-type element is clicked.
    $('[wr-type="submit"]').on("click", function () {
      formErrors = false;
      $('[wr-type="required-field"]').each(function () {
        var $this = $(this);
        var val = $this.val();

        // Check if field is empty.
        if (!val) {
          fieldError($this);
          return;
        }

        // Validate email fields.
        if ($this.attr("type") === "email" && (val.indexOf("@") === -1 || val.indexOf(".") === -1)) {
          fieldError($this);
          return;
        }
      });

      if (!formErrors) {
        $(this).closest("form").submit();
      }
    });

    // Remove errors on keypress or blur.
    $('[wr-type="required-field"]').on("keypress blur", function () {
      clearFieldError($(this));
    });

    // Pressing Enter triggers form submission.
    $("input, textarea").on("keypress", function (e) {
      if (e.keyCode === 13) {
        e.preventDefault();
        $(this).trigger("change");
        $('[wr-type="submit"]').click();
      }
    });

    // Get the main Rent Form.
    var rentForm = document.getElementById("wf-form-Rent-Form");

    // ---- Step 1: Date Selection ----
    var datePickers = rentForm.querySelectorAll(".flatpickr-input");
    var getStartedBtn = rentForm.querySelector("#slider-1");

    // Initialize first flatpickr (index 0).
    var fp1 = flatpickr(datePickers[0], {
      minDate: "today",
      mode: "range"
    });

    // Check that the date picker is filled before proceeding.
    function checkForm(e) {
      if (!datePickers[0].value) {
        e.preventDefault();
        e.stopPropagation();
        fieldError($("#dates")); // Assumes an element with ID "dates" shows the error.
      }
    }
    getStartedBtn.addEventListener("click", checkForm, true);

    // ---- Step 2: With Driver / Self Drive ----
    var withDriver = document.getElementById("with-driver");
    var selfDrive = document.getElementById("self-drive");
    var licenseFront = document.getElementById("Driving-License-Front");
    var licenseBack = document.getElementById("Driving-License-Back");
    var licenseDetailsFront = document.getElementById("license-details-front");
    var licenseDetailsBack = document.getElementById("license-details-back");

    // Set default: "With Driver" is selected.
    if (withDriver) withDriver.checked = true;
    if (selfDrive) selfDrive.checked = false;
    if (licenseDetailsFront) licenseDetailsFront.style.display = "none";
    if (licenseDetailsBack) licenseDetailsBack.style.display = "none";

    // Toggle license details based on the driver option.
    function toggleLicenseDetails() {
      if (selfDrive && selfDrive.checked) {
        // When Self Drive is selected, uncheck With Driver and display license upload fields.
        if (withDriver) withDriver.checked = false;
        if (licenseDetailsFront) licenseDetailsFront.style.display = "block";
        if (licenseDetailsBack) licenseDetailsBack.style.display = "block";
      } else {
        // When Self Drive is not selected, force With Driver to be selected and hide license fields.
        if (withDriver) withDriver.checked = true;
        if (licenseDetailsFront) licenseDetailsFront.style.display = "none";
        if (licenseDetailsBack) licenseDetailsBack.style.display = "none";
        clearFieldError($("#Driving-License-Front"));
        clearFieldError($("#Driving-License-Back"));
      }
    }
    if (withDriver) withDriver.addEventListener("change", toggleLicenseDetails);
    if (selfDrive) selfDrive.addEventListener("change", toggleLicenseDetails);

    // Validate Step 2 before proceeding.
    var slider2 = document.getElementById("slider-2");
    function validateStep2(e) {
      // Prevent proceeding if neither option is checked.
      if ((!withDriver || !withDriver.checked) && (!selfDrive || !selfDrive.checked)) {
        e.preventDefault();
        e.stopPropagation();
        fieldError($("#with-driver"));
        fieldError($("#self-drive"));
        return false;
      }
      // If Self Drive is selected, both license uploads must be provided.
      if (selfDrive && selfDrive.checked) {
        var valid = true;
        if (!licenseFront || licenseFront.files.length === 0) {
          fieldError($("#license-details-front"));
          valid = false;
        }
        if (!licenseBack || licenseBack.files.length === 0) {
          fieldError($("#license-details-back"));
          valid = false;
        }
        if (!valid) {
          e.preventDefault();
          e.stopPropagation();
          return false;
        }
      }
      return true;
    }
    if (slider2) {
      slider2.addEventListener("click", function (e) {
        if (validateStep2(e)) {
          Webflow.push(function () {
            // Navigate to Step 3 (insert your custom navigation logic here).
          });
        }
      }, true);
    }

    // ---- Step 3: Airport Pickup ----
    var airportPickup = document.getElementById("airport-pickup");
    var flightNumber = document.getElementById("flight-number");
    var flightTime = document.getElementById("flight-time");
    var nextStepBtn2 = rentForm.querySelector("#slider-3");

    // Initialize second flatpickr (index 1).
    var fp2 = flatpickr(datePickers[1], {
      minDate: "today",
      mode: "range"
    });

    // Remove extra attributes from optional fields.
    $(datePickers[1]).removeAttr("wr-type required");
    if (flightNumber) $(flightNumber).removeAttr("wr-type required");
    if (flightTime) $(flightTime).removeAttr("wr-type required");

    // Validate airport pickup details.
    function checkForm3(e) {
      if (airportPickup && airportPickup.checked) {
        if (!flightNumber || !flightNumber.value) {
          e.preventDefault();
          e.stopPropagation();
          fieldError($("#flight-number"));
        }
        if (!flightTime || !flightTime.value) {
          e.preventDefault();
          e.stopPropagation();
          fieldError($("#flight-time"));
        }
        if (!datePickers[1].value) {
          e.preventDefault();
          e.stopPropagation();
          fieldError($("#pick-up-drop-off-date"));
        }
      }
    }
    if (nextStepBtn2) nextStepBtn2.addEventListener("click", checkForm3, true);

    // ---- Step 4: Out of Accra ----
    var outOfAccra = document.getElementById("Out-Of-Accra");
    var nextStepBtn3 = rentForm.querySelector(".slide:nth-child(4) .slider-right.w-button");
    var checkbox9 = document.querySelectorAll("[name='checkbox-9']");
    if (outOfAccra) outOfAccra.removeAttribute("required");

    function checkForm4(e) {
      if (outOfAccra && outOfAccra.checked) {
        var regionSelected = false;
        checkbox9.forEach(function (checkbox) {
          if (checkbox.checked) {
            regionSelected = true;
          }
        });
        if (!regionSelected) {
          e.preventDefault();
          e.stopPropagation();
          // Optionally, display an error message indicating that a region must be selected.
        }
      }
    }
    if (nextStepBtn3) nextStepBtn3.addEventListener("click", checkForm4, true);

    // ---- Final Step: File Upload Requirement ----
    var file2 = document.querySelectorAll("#id-upload");
    if (file2 && file2.length > 1) {
      file2[1].setAttribute("wr-type", "required-field");
    }

    // ---- Form Customization: Toggle Display for Out of Accra, Self Drive & Airport Pickup ----
    var checkboxLocation = document.getElementById("Out-Of-Accra");
    var checkboxLicense = document.getElementById("self-drive");
    var checkboxPickup = document.getElementById("airport-pickup");
    var locationDetails = document.getElementById("location-details");
    var licenseDetails = document.getElementById("license-details");
    var airportDetails = document.getElementById("airportpick-details");

    if (locationDetails) locationDetails.style.display = "none";
    if (licenseDetails) licenseDetails.style.display = "none";
    if (airportDetails) airportDetails.style.display = "none";

    if (checkboxLocation && locationDetails) {
      checkboxLocation.addEventListener("click", function () {
        locationDetails.style.display = checkboxLocation.checked ? "block" : "none";
      });
    }
    if (checkboxLicense && licenseDetails) {
      checkboxLicense.addEventListener("click", function () {
        licenseDetails.style.display = checkboxLicense.checked ? "block" : "none";
      });
    }
    if (checkboxPickup && airportDetails) {
      checkboxPickup.addEventListener("click", function () {
        airportDetails.style.display = checkboxPickup.checked ? "block" : "none";
      });
    }

    // ---- Search Feature for Out of Accra ----
    $(".on-page-search").on("keyup", function () {
      var searchVal = $(this).val();
      $(".results").removeClass("results");
      $(".noresults").removeClass("noresults");

      $(".search-result").each(function () {
        var $this = $(this);
        if (searchVal !== "" && $this.text().search(new RegExp(searchVal, "gi")) !== -1) {
          $this.addClass("results");
        } else if (searchVal !== "" && $this.text().search(searchVal) === -1) {
          $this.addClass("noresults");
        }
      });
    });

    // ---- Populate Model Fields and Page URL on Window Load ----
    $(window).on("load", function () {
      var model = document.getElementById("make");
      var carName = document.getElementById("car-name");
      var modelInput1 = document.getElementById("Vehicle-Model-Number");
      var modelInput2 = document.getElementById("Vehicle-Model-Number-2");
      var modelInput3 = document.getElementById("Vehicle-Model-Number-3");
      var modelInput4 = document.getElementById("Vehicle-Model-Number-4");
      var pageNameInput = document.getElementById("page-name");

      if (model && carName) {
        var modelInfo = model.textContent + " " + carName.textContent;
        if (modelInput1) modelInput1.value = modelInfo;
        if (modelInput2) modelInput2.value = modelInfo;
        if (modelInput3) modelInput3.value = modelInfo;
        if (modelInput4) modelInput4.value = modelInfo;
      }
      if (pageNameInput) pageNameInput.value = window.location.href;
    });
  });
</script>
