<script>
/* 
====================================================
1) Enable multiple file uploads
==================================================== 
*/
$("input[type=file]").attr("multiple", "multiple");

/* 
====================================================
2) Main Form Validation & Multi-Step Logic
==================================================== 
*/
$(document).ready(function () {
  "use strict";

  // Hide all error messages and remove error classes
  $('[wr-type="error"]').hide();
  $('[wr-type="required-field"]').removeClass("error");

  let formErrors = false;

  /**
   * fieldError($field)
   * -------------------
   * Displays error messages for a field and sets a global flag.
   */
  const fieldError = function ($field) {
    $field.siblings('[wr-type="error"]').show();
    $field.addClass("error");
    formErrors = true;
  };

  /**
   * clearFieldError($field)
   * ------------------------
   * Hides error messages for a field and removes error class.
   */
  const clearFieldError = function ($field) {
    $field.removeClass("error");
    $field.siblings('[wr-type="error"]').hide();
    formErrors = false; 
  };

  // FINAL SUBMISSION (checks all wr-type="required-field")
  $('[wr-type="submit"]').on("click", function () {
    formErrors = false; // reset each time

    // Validate all required fields
    $('[wr-type="required-field"]').each(function () {
      const $this = $(this);
      const val = $this.val();

      // Empty check
      if (!val) {
        fieldError($this);
        return;
      }

      // Email check
      if (
        $this.attr("type") === "email" &&
        (val.indexOf("@") === -1 || val.indexOf(".") === -1)
      ) {
        fieldError($this);
        return;
      }
    });

    // If no errors, submit parent form
    if (!formErrors) {
      $(this).parents("form").submit();
    }
  });

  // Clear errors on keypress or blur for any required field
  $('[wr-type="required-field"]').on("keypress blur", function () {
    clearFieldError($(this));
  });

  // Press Enter => trigger final submit
  $("input, textarea").on("keypress", function (e) {
    if (e.keyCode === 13) {
      e.preventDefault();
      $(this).trigger("change");
      $('[wr-type="submit"]').click();
    }
  });

  // Reference to the main Rent Form
  const rentForm = document.getElementById("wf-form-Rent-Form");

  /*---------------------------------------------------
   STEP 1: First Modal => #slider-1
   Validate the first date input
  ----------------------------------------------------*/
  const datePickers = rentForm.querySelectorAll(".flatpickr-input");
  const getStartedBtn = rentForm.querySelector("#slider-1");

  // Initialize Flatpickr #1
  const fp1 = flatpickr(datePickers[0], {
    minDate: "today",
    mode: "range",
  });

  function checkFormStep1(e) {
    if (!datePickers[0].value) {
      e.preventDefault();
      e.stopPropagation();
      fieldError($("#dates"));
    }
  }
  getStartedBtn.addEventListener("click", checkFormStep1, true);

  /*---------------------------------------------------
   STEP 2: Second Modal => #slider-2
   Validate "With Driver" vs. "Self Drive"
  ----------------------------------------------------*/
  const withDriver = document.getElementById("with-driver");
  const selfDrive = document.getElementById("self-drive");
  const fileInput = rentForm.querySelector("#file");
  const nextStepBtn1 = rentForm.querySelector("#slider-2");

  // By default, check "With Driver"
  withDriver.checked = false;
  withDriver.click();

  function checkFormStep2(e) {
    // Must select at least 1
    if (!withDriver.checked && !selfDrive.checked) {
      e.preventDefault();
      e.stopPropagation();
      fieldError($("#with-driver"));
      fieldError($("#self-drive"));
    } 
    // If Self Drive => at least one file must be uploaded
    else if (selfDrive.checked && fileInput.files.length === 0) {
      e.preventDefault();
      e.stopPropagation();
      fieldError($("#file-upload"));
    }
  }
  nextStepBtn1.addEventListener("click", checkFormStep2, true);

  // Remove errors if user toggles driver checkboxes
  function removeDriverErrors() {
    if (withDriver.checked || selfDrive.checked) {
      clearFieldError($("#with-driver"));
      clearFieldError($("#self-drive"));
    }
  }
  withDriver.addEventListener("change", removeDriverErrors);
  selfDrive.addEventListener("change", removeDriverErrors);

  /*---------------------------------------------------
   STEP 3: Third Modal => #slider-3
   Validate Airport Pickup if selected
  ----------------------------------------------------*/
  const airportPickup = document.getElementById("airport-pickup");
  const flightNumber = document.getElementById("flight-number");
  const flightTime = document.getElementById("flight-time");
  const nextStepBtn2 = rentForm.querySelector("#slider-3");

  // Initialize Flatpickr #2
  const fp2 = flatpickr(datePickers[1], {
    minDate: "today",
    mode: "range",
  });

  // Remove wr-type & required from optional fields
  datePickers[1].removeAttribute("wr-type");
  datePickers[1].removeAttribute("required");
  flightNumber.removeAttribute("wr-type");
  flightNumber.removeAttribute("required");
  flightTime.removeAttribute("wr-type");
  flightTime.removeAttribute("required");

  function checkFormStep3(e) {
    if (
      airportPickup.checked &&
      (!flightNumber.value || !flightTime.value || !datePickers[1].value)
    ) {
      e.preventDefault();
      e.stopPropagation();

      if (!flightNumber.value) fieldError($("#flight-number"));
      if (!flightTime.value) fieldError($("#flight-time"));
      if (!datePickers[1].value) fieldError($("#pick-up-drop-off-date"));
    }
  }
  nextStepBtn2.addEventListener("click", checkFormStep3, true);

  /*---------------------------------------------------
   STEP 4: Fourth Modal => .slide:nth-child(4) .slider-right
   "Out of Accra" => Must choose at least 1 region
  ----------------------------------------------------*/
  const outOfAccra = document.getElementById("Out-Of-Accra");
  const nextStepBtn3 = rentForm.querySelector(".slide:nth-child(4) .slider-right.w-button");
  const checkbox9 = document.querySelectorAll("[name='checkbox-9']");

  outOfAccra.removeAttribute("required");

  function checkFormStep4(e) {
    if (outOfAccra.checked) {
      let regionSelected = false;
      for (let i = 0; i < checkbox9.length; i++) {
        if (checkbox9[i].checked) {
          regionSelected = true;
          break;
        }
      }
      if (!regionSelected) {
        e.preventDefault();
        e.stopPropagation();
      }
    }
  }
  nextStepBtn3.addEventListener("click", checkFormStep4, true);

  /*---------------------------------------------------
   LAST STEP: Example => #id-upload 
   (If you still have #id-upload fields)
  ----------------------------------------------------*/
  const file2 = document.querySelectorAll("#id-upload");
  // Make sure the second #id-upload is required
  if (file2[1]) {
    file2[1].setAttribute("wr-type", "required-field");
  }
});

/* 
====================================================
3) Show/Hide Customization (Out of Accra, Self Drive, Airport)
==================================================== 
*/
var Webflow = Webflow || [];
Webflow.push(function () {
  var checkboxLocation = document.getElementById("Out-Of-Accra");
  var checkboxLicense  = document.getElementById("self-drive");
  var checkboxPickup   = document.getElementById("airport-pickup");
  var locationDetails  = document.getElementById("location-details");
  var licenseDetails   = document.getElementById("license-details");
  var airportDetails   = document.getElementById("airportpick-details");

  // **Hide these three sections by default** 
  locationDetails.style.display = "none";
  licenseDetails.style.display  = "none";
  airportDetails.style.display  = "none";

  // Toggle location details
  checkboxLocation.addEventListener("click", function () {
    locationDetails.style.display = checkboxLocation.checked ? "block" : "none";
  });

  // Toggle license details
  checkboxLicense.addEventListener("click", function () {
    licenseDetails.style.display = checkboxLicense.checked ? "block" : "none";
  });

  // Toggle airport details
  checkboxPickup.addEventListener("click", function () {
    airportDetails.style.display = checkboxPickup.checked ? "block" : "none";
  });
});

/* 
====================================================
4) Search Feature for Out-of-Accra Regions
==================================================== 
*/
$(".on-page-search").on("keyup", function () {
  var v = $(this).val();
  $(".results").removeClass("results");
  $(".noresults").removeClass("noresults");

  $(".search-result").each(function () {
    var $this = $(this);
    if (v !== "" && $this.text().search(new RegExp(v, "gi")) !== -1) {
      $this.addClass("results");
    } else if (v !== "" && $this.text().search(v) !== 1) {
      $this.addClass("noresults");
    }
  });
});

/* 
====================================================
5) On Window Load => Populate Model Fields + Page URL
==================================================== 
*/
window.addEventListener("load", function () {
  const model = document.getElementById("make");
  const carName = document.getElementById("car-name");

  const modelInput1 = document.getElementById("Vehicle-Model-Number");
  const modelInput2 = document.getElementById("Vehicle-Model-Number-2");
  const modelInput3 = document.getElementById("Vehicle-Model-Number-3");
  const modelInput4 = document.getElementById("Vehicle-Model-Number-4");

  const pageNameInput = document.getElementById("page-name");
  const modelInfo = model.textContent + " " + carName.textContent;

  // Populate model fields
  modelInput1.value = modelInfo;
  modelInput2.value = modelInfo;
  modelInput3.value = modelInfo;
  modelInput4.value = modelInfo;

  // Add page URL to the "page-name" field
  pageNameInput.value = window.location.href;
});
</script>
