<!-- Enables multiple files for all file inputs -->
<script>
  $("input[type=file]").attr("multiple", "multiple");
</script>

<script>
  $(document).ready(function () {
    "use strict";

    //---------------------------------------------------------------
    // Setup: Hide error messages and remove error classes on page load
    //---------------------------------------------------------------
    $('[wr-type="error"]').hide();
    $('[wr-type="required-field"]').removeClass("error");

    let formErrors = false;

    /**
     * fieldError($field)
     * -------------------
     * Displays error messages for a field and adds an error class.
     * Also sets a global flag (formErrors = true).
     */
    const fieldError = function ($field) {
      $field.siblings('[wr-type="error"]').show(); // show the error message
      $field.addClass("error");                    // add error class
      formErrors = true;
    };

    /**
     * clearFieldError($field)
     * -----------------------
     * Hides error messages for a field and removes error class.
     * Also resets formErrors = false so the form can submit if all else is fine.
     */
    const clearFieldError = function ($field) {
      $field.removeClass("error");
      $field.siblings('[wr-type="error"]').hide();
      formErrors = false;
    };

    //---------------------------------------------------------------
    // Final Form Submission (when user clicks the main Submit button)
    // This validation will check ALL wr-type="required-field" fields.
    //---------------------------------------------------------------
    $('[wr-type="submit"]').on("click", function () {
      // Reset formErrors before this validation pass
      formErrors = false;

      // 1) Loop through every wr-type="required-field"...
      $('[wr-type="required-field"]').each(function () {
        const $this = $(this);
        const val = $this.val();

        // 2) Check if empty
        if (!val) {
          fieldError($this);
          return;
        }

        // 3) If it's an email field, check for '@' and '.'
        if (
          $this.attr("type") === "email" &&
          (val.indexOf("@") === -1 || val.indexOf(".") === -1)
        ) {
          fieldError($this);
          return;
        }
      });

      // 4) If no errors, we can safely submit the parent form
      if (!formErrors) {
        $(this).parents("form").submit();
      }
    });

    //---------------------------------------------------------------
    // Clear errors whenever user types or blurs any required field
    //---------------------------------------------------------------
    $('[wr-type="required-field"]').on("keypress blur", function () {
      clearFieldError($(this));
    });

    //---------------------------------------------------------------
    // Pressing "Enter" triggers the same as clicking submit
    //---------------------------------------------------------------
    $("input, textarea").on("keypress", function (e) {
      if (e.keyCode === 13) {
        e.preventDefault();
        $(this).trigger("change");
        $('[wr-type="submit"]').click();
      }
    });

    //---------------------------------------------------------------
    // REFERENCE: The Multi-Step "Rent Form"
    //---------------------------------------------------------------
    const rentForm = document.getElementById("wf-form-Rent-Form");

    //---------------------------------------------------------------
    // STEP 1: "Slider-1"
    // Validate the first date input (datePickers[0]) before going next
    //---------------------------------------------------------------
    const datePickers = rentForm.querySelectorAll(".flatpickr-input");
    const getStartedBtn = rentForm.querySelector("#slider-1");

    // Initialize the first Flatpickr (datePickers[0])
    const fp1 = flatpickr(datePickers[0], {
      minDate: "today",
      mode: "range",
    });

    // This function runs when user clicks the "next" button on step 1
    function checkFormStep1(e) {
      // If the first date input is empty => show error & block next step
      if (!datePickers[0].value) {
        e.preventDefault();
        e.stopPropagation();
        fieldError($("#dates")); // (#dates) is presumably the same input or container
      }
    }

    getStartedBtn.addEventListener("click", checkFormStep1, true);

    //---------------------------------------------------------------
    // STEP 2: "Slider-2"
    // Validates either "With Driver" or "Self-Drive" plus license uploads
    //---------------------------------------------------------------
    const withDriver = document.getElementById("with-driver");
    const selfDrive = document.getElementById("self-drive");

    // NEW: The two license upload fields if "Self Drive" is chosen
    const licenseFront = rentForm.querySelector("#license-upload-front");
    const licenseBack = rentForm.querySelector("#license-upload-back");

    // The second "next" button
    const nextStepBtn1 = rentForm.querySelector("#slider-2");

    // By default, we auto-check "With Driver"
    withDriver.checked = false;
    withDriver.click();

    // This function runs when user clicks "next" on step 2
    function checkFormStep2(e) {
      // Must pick at least one: withDriver or selfDrive
      if (!withDriver.checked && !selfDrive.checked) {
        e.preventDefault();
        e.stopPropagation();
        fieldError($("#with-driver"));
        fieldError($("#self-drive"));
      }
      // If "Self Drive" is selected => both license uploads must have files
      else if (selfDrive.checked) {
        if (
          licenseFront.files.length === 0 ||
          licenseBack.files.length === 0
        ) {
          e.preventDefault();
          e.stopPropagation();
          fieldError($("#license-upload-front"));
          fieldError($("#license-upload-back"));
        }
      }
    }

    nextStepBtn1.addEventListener("click", checkFormStep2, true);

    // Remove driver errors if either withDriver or selfDrive changes
    function removeDriverErrors() {
      if (withDriver.checked || selfDrive.checked) {
        clearFieldError($("#with-driver"));
        clearFieldError($("#self-drive"));
      }
    }

    withDriver.addEventListener("change", removeDriverErrors);
    selfDrive.addEventListener("change", removeDriverErrors);

    //---------------------------------------------------------------
    // STEP 3: "Slider-3"
    // Validates "Airport Pickup" info (Flight #, Time, 2nd dateRange)
    //---------------------------------------------------------------
    const airportPickup = document.getElementById("airport-pickup");
    const flightNumber = document.getElementById("flight-number");
    const flightTime = document.getElementById("flight-time");
    const nextStepBtn2 = rentForm.querySelector("#slider-3");

    // Initialize the second Flatpickr (datePickers[1])
    const fp2 = flatpickr(datePickers[1], {
      minDate: "today",
      mode: "range",
    });

    // Because these fields are optional if Airport Pickup is NOT checked,
    // we remove wr-type="required-field" from them
    datePickers[1].removeAttribute("wr-type");
    flightNumber.removeAttribute("wr-type");
    flightTime.removeAttribute("wr-type");
    datePickers[1].removeAttribute("required");
    flightNumber.removeAttribute("required");
    flightTime.removeAttribute("required");

    // This function runs when user clicks "next" on step 3
    // Only validate flight info IF airportPickup is checked
    function checkFormStep3(e) {
      if (
        airportPickup.checked &&
        (!flightNumber.value || !flightTime.value || !datePickers[1].value)
      ) {
        e.preventDefault();
        e.stopPropagation();

        if (!flightNumber.value) fieldError($("#flight-number"));
        if (!flightTime.value) fieldError($("#flight-time"));
        if (!datePickers[1].value) fieldError($("#pick-up-drop-off-date"));
      }
    }

    nextStepBtn2.addEventListener("click", checkFormStep3, true);

    //---------------------------------------------------------------
    // STEP 4: "slider-right.w-button" in .slide:nth-child(4)
    // Validates region selection if "Out of Accra" is checked
    //---------------------------------------------------------------
    const outOfAccra = document.getElementById("Out-Of-Accra");
    const nextStepBtn3 = rentForm.querySelector(".slide:nth-child(4) .slider-right.w-button");
    const checkbox9 = document.querySelectorAll("[name='checkbox-9']");

    // Removing required from the "Out of Accra" checkbox if it existed
    outOfAccra.removeAttribute("required");

    // This function runs when user clicks "next" on step 4
    // If Out of Accra is checked => must select at least 1 region
    function checkFormStep4(e) {
      if (outOfAccra.checked) {
        let regionSelected = false;
        for (let i = 0; i < checkbox9.length; i++) {
          if (checkbox9[i].checked) {
            regionSelected = true;
            break;
          }
        }
        if (!regionSelected) {
          e.preventDefault();
          e.stopPropagation();
          // NOTE: This code does NOT show a direct field error message,
          // but it prevents going to the next step if no region is selected.
        }
      }
    }

    nextStepBtn3.addEventListener("click", checkFormStep4, true);

    //---------------------------------------------------------------
    // Last Modal: ID Upload
    //  - #id-upload-front
    //  - #id-upload-back
    // We make them required if they must be validated on final submission
    //---------------------------------------------------------------
    const idFront = document.getElementById("id-upload-front");
    const idBack = document.getElementById("id-upload-back");

    // Setting these as required
    idFront.setAttribute("wr-type", "required-field");
    idBack.setAttribute("wr-type", "required-field");
  });
</script>

<!-- Form Customization of Out of Accra, Self Drive & Airport PickUp -->
<script>
  var Webflow = Webflow || [];
  Webflow.push(function () {
    // Basic show/hide sections
    var checkboxLocation = document.getElementById("Out-Of-Accra");
    var checkboxLicense = document.getElementById("self-drive");
    var checkboxPickup = document.getElementById("airport-pickup");
    var locationDetails = document.getElementById("location-details");
    var licenseDetails = document.getElementById("license-details");
    var airportDetails = document.getElementById("airportpick-details");

    locationDetails.style.display = "none";
    licenseDetails.style.display = "none";
    airportDetails.style.display = "none";

    // Toggle location details
    checkboxLocation.addEventListener("click", function () {
      locationDetails.style.display = checkboxLocation.checked ? "block" : "none";
    });

    // Toggle license details
    checkboxLicense.addEventListener("click", function () {
      licenseDetails.style.display = checkboxLicense.checked ? "block" : "none";
    });

    // Toggle airport details
    checkboxPickup.addEventListener("click", function () {
      airportDetails.style.display = checkboxPickup.checked ? "block" : "none";
    });
  });
</script>

<!-- Search Feature - Out of Accra -->
<script>
  $(".on-page-search").on("keyup", function () {
    var v = $(this).val();
    $(".results").removeClass("results");
    $(".noresults").removeClass("noresults");

    $(".search-result").each(function () {
      var $this = $(this);
      if (v !== "" && $this.text().search(new RegExp(v, "gi")) !== -1) {
        $this.addClass("results");
      } else if (v !== "" && $this.text().search(v) !== 1) {
        $this.addClass("noresults");
      }
    });
  });
</script>

<script>
  // On window load, set the "Vehicle Model" hidden fields & page URL
  window.addEventListener("load", function () {
    const model = document.getElementById("make");
    const carName = document.getElementById("car-name");

    const modelInput1 = document.getElementById("Vehicle-Model-Number");
    const modelInput2 = document.getElementById("Vehicle-Model-Number-2");
    const modelInput3 = document.getElementById("Vehicle-Model-Number-3");
    const modelInput4 = document.getElementById("Vehicle-Model-Number-4");

    const pageNameInput = document.getElementById("page-name");

    const modelInfo = model.textContent + " " + carName.textContent;

    // Populate model fields
    modelInput1.value = modelInfo;
    modelInput2.value = modelInfo;
    modelInput3.value = modelInfo;
    modelInput4.value = modelInfo;

    // Add the page URL to the "page-name" field
    pageNameInput.value = window.location.href;
  });
</script>
