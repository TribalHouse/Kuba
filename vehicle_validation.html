<script>
// Wait for Webflow and jQuery to be ready
(function($, Webflow) {
  'use strict';

  class FormValidator {
    constructor(formId) {
      this.form = document.getElementById(formId);
      this.fields = {
        required: '[wr-type="required-field"]',
        error: '[wr-type="error"]',
        submit: '[wr-type="submit"]'
      };
      this.init();
    }

    init() {
      this.setupEventListeners();
      this.enhanceFileInputs();
      this.initDatePickers();
      this.setupConditionalSections();
      this.initializeFormDependencies();
    }

    setupEventListeners() {
      $(this.form).on('click', this.fields.submit, this.validateForm.bind(this));
      $(this.form).on('input change', this.fields.required, this.clearErrors.bind(this));
      $(this.form).on('keypress', 'input, textarea', this.handleEnterKey.bind(this));
    }

    enhanceFileInputs() {
      $('input[type="file"]')
        .attr('multiple', true)
        .on('change', this.validateFileUpload.bind(this));
    }

    initDatePickers() {
      this.flatpickrInstances = Array.from(
        this.form.querySelectorAll('.flatpickr-input')
      ).map((el, index) => {
        return flatpickr(el, {
          minDate: 'today',
          mode: index === 0 ? 'range' : 'single'
        });
      });
    }

    validateForm(e) {
      e.preventDefault();
      this.resetErrors();
      let isValid = true;

      // Validate required fields
      $(this.fields.required).each((i, field) => {
        const $field = $(field);
        if (!this.validateField($field)) isValid = false;
      });

      // Custom validation checks
      if (!this.checkDriverSelection()) isValid = false;
      if (!this.checkAirportPickup()) isValid = false;
      if (!this.checkOutOfAccra()) isValid = false;

      if (isValid) {
        this.form.submit();
      }
    }

    validateField($field) {
      const value = $field.val().trim();
      let isValid = true;

      if ($field.prop('required') && !value) {
        this.showError($field, 'This field is required');
        isValid = false;
      }

      if ($field.attr('type') === 'email' && !this.validateEmail(value)) {
        this.showError($field, 'Please enter a valid email address');
        isValid = false;
      }

      if ($field.attr('type') === 'file' && !this.validateFiles($field[0])) {
        this.showError($field, 'Please upload valid files');
        isValid = false;
      }

      return isValid;
    }

    validateFiles(fileInput) {
      if (!fileInput.files.length) return false;
      const maxSize = 5 * 1024 * 1024; // 5MB
      const allowedTypes = ['image/jpeg', 'image/png', 'application/pdf'];
      
      return Array.from(fileInput.files).every(file => {
        return allowedTypes.includes(file.type) && file.size <= maxSize;
      });
    }

    validateEmail(email) {
      return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
    }

    showError($field, message) {
      $field.addClass('error').siblings(this.fields.error)
        .text(message).show();
    }

    clearErrors(e) {
      const $field = $(e.target);
      $field.removeClass('error')
        .siblings(this.fields.error).hide();
    }

    handleEnterKey(e) {
      if (e.keyCode === 13) {
        e.preventDefault();
        $(this.fields.submit).click();
      }
    }

    // Additional validation methods
    checkDriverSelection() {
      const driverChecked = $('#with-driver').is(':checked');
      const selfDriveChecked = $('#self-drive').is(':checked');
      
      if (!driverChecked && !selfDriveChecked) {
        this.showError($('#driver-section'), 'Please select a driver option');
        return false;
      }
      return true;
    }

    checkAirportPickup() {
      if ($('#airport-pickup').is(':checked')) {
        const flightValid = $('#flight-number').val().trim() !== '';
        const timeValid = $('#flight-time').val().trim() !== '';
        const dateValid = this.flatpickrInstances[1].selectedDates.length > 0;

        if (!flightValid || !timeValid || !dateValid) {
          if (!flightValid) this.showError($('#flight-number'), 'Flight number required');
          if (!timeValid) this.showError($('#flight-time'), 'Flight time required');
          if (!dateValid) this.showError($('#pick-up-drop-off-date'), 'Date required');
          return false;
        }
      }
      return true;
    }

    checkOutOfAccra() {
      if ($('#Out-Of-Accra').is(':checked')) {
        const regionSelected = $('[name="checkbox-9"]:checked').length > 0;
        if (!regionSelected) {
          this.showError($('#region-section'), 'Please select at least one region');
          return false;
        }
      }
      return true;
    }

    setupConditionalSections() {
      const sections = {
        '#Out-Of-Accra': '#location-details',
        '#self-drive': '#license-details',
        '#airport-pickup': '#airportpick-details'
      };

      Object.entries(sections).forEach(([trigger, target]) => {
        $(trigger).on('change', () => {
          $(target).toggle($(trigger).is(':checked'));
        }).trigger('change');
      });
    }

    initializeFormDependencies() {
      // Initialize model inputs
      const modelName = $('#make').text() + ' ' + $('#car-name').text();
      $('[id^="Vehicle-Model-Number"]').val(modelName);
      
      // Set page URL
      $('#page-name').val(window.location.href);

      // Initialize search
      $(".on-page-search").on("input", this.handleSearch.bind(this));
    }

    handleSearch(e) {
      const query = $(e.target).val().toLowerCase();
      $(".search-result").each((i, el) => {
        const $item = $(el);
        $item.toggle($item.text().toLowerCase().includes(query));
      });
    }
  }

  // Initialize when Webflow is ready
  Webflow.push(() => {
    new FormValidator('wf-form-Rent-Form');
  });

})(jQuery, Webflow);
</script>
