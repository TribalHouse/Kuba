<script>
$(document).ready(function () {
  "use strict";

  // --------------------------------------------------------------
  // Global Constants & Configuration
  // --------------------------------------------------------------
  const $form = $("#wf-form-Rent-Form");
  const $datePickers = $(".flatpickr-input");
  let formErrors = false;

  // Data attribute selectors
  const selectors = {
    error: '[data-error]',
    required: '[data-required]',
    uploadSuccess: '[data-upload-success]'
  };

  // --------------------------------------------------------------
  // Core Validation Utilities
  // --------------------------------------------------------------
  function fieldError($field) {
    const $container = $field.closest('[data-field-container]');
    $container.addClass('error').find(selectors.error).show();
    formErrors = true;
  }

  function clearFieldError($field) {
    const $container = $field.closest('[data-field-container]');
    $container.removeClass('error').find(selectors.error).hide();
  }

  // --------------------------------------------------------------
  // Step 1: Date Selection
  // --------------------------------------------------------------
  function initDatePickers() {
    const $getStartedBtn = $('#slider-1');
    const fp1 = flatpickr($datePickers[0], { 
      minDate: "today", 
      mode: "range" 
    });

    function validateDates(e) {
      if (!$datePickers.eq(0).val()) {
        e.preventDefault();
        fieldError($datePickers.eq(0).closest('[data-field-container]'));
      }
    }

    $getStartedBtn.on('click', validateDates);
  }

  // --------------------------------------------------------------
  // Step 2: Driver Options & License Upload
  // --------------------------------------------------------------
  function initDriverOptions() {
    const $withDriver = $('#with-driver');
    const $selfDrive = $('#self-drive');
    const $licenseFront = $('#license-details-front');
    const $licenseBack = $('#license-details-back');

    function toggleDriverOptions() {
      if ($selfDrive.prop('checked')) {
        $licenseFront.add($licenseBack).show();
      } else {
        $licenseFront.add($licenseBack).hide()
          .find('input[type="file"]').val('');
        clearFieldError($licenseFront.add($licenseBack));
      }
    }

    $withDriver.add($selfDrive).on('change', function() {
      const isChecked = $(this).prop('checked');
      $(this).closest('label').toggleClass('active', isChecked);
      clearFieldError($(this).closest('[data-field-container]'));
      
      if ($(this).is($selfDrive)) toggleDriverOptions();
    });

    $('#slider-2').on('click', function(e) {
      formErrors = false;
      
      // Validate driver selection
      if (!$withDriver.prop('checked') && !$selfDrive.prop('checked')) {
        fieldError($withDriver.closest('[data-field-container]'));
        fieldError($selfDrive.closest('[data-field-container]'));
        return false;
      }

      // Validate license uploads if self-drive
      if ($selfDrive.prop('checked')) {
        $licenseFront.add($licenseBack).each(function() {
          const $input = $(this).find('input[type="file"]');
          if (!$input.val()) fieldError($(this));
        });
      }

      if (formErrors) e.preventDefault();
    });
  }

  // --------------------------------------------------------------
  // Step 3: Airport Pickup
  // --------------------------------------------------------------
  function initAirportPickup() {
    const $airportPickup = $('#airport-pickup');
    const $flightNumber = $('#flight-number');
    const $flightTime = $('#flight-time');
    const fp2 = flatpickr($datePickers[1], { 
      minDate: "today", 
      mode: "range" 
    });

    $('#slider-3').on('click', function(e) {
      if (!$airportPickup.prop('checked')) return;
      
      formErrors = false;
      const requiredFields = [$flightNumber, $flightTime, $datePickers.eq(1)];
      
      requiredFields.forEach($field => {
        if (!$field.val()) fieldError($field.closest('[data-field-container]'));
      });

      if (formErrors) e.preventDefault();
    });
  }

  // --------------------------------------------------------------
  // Final Submission & File Upload Handling
  // --------------------------------------------------------------
  function initFormSubmission() {
    $form.off('submit').on('submit', function(e) {
      formErrors = false;
      
      // Validate passport uploads
      $('#id-upload-front, #id-upload-back').each(function() {
        const $input = $(this).find('input[type="file"]');
        if (!$input.val()) fieldError($(this));
      });

      // Cleanup unused checkboxes
      $('.multi-select-wrap input[type="checkbox"]:not(:checked)').removeAttr('name');

      if (formErrors) {
        e.preventDefault();
        $form[0].scrollIntoView({ behavior: 'smooth' });
      }
    });
  }

  // --------------------------------------------------------------
  // Initialization
  // --------------------------------------------------------------
  function init() {
    $('input[type="file"]').attr('multiple', true);
    $(selectors.error).hide();
    $(selectors.required).removeClass('error');

    initDatePickers();
    initDriverOptions();
    initAirportPickup();
    initFormSubmission();

    // Dynamic field population
    $(window).on('load', function() {
      const modelInfo = $('#make').text() + ' ' + $('#car-name').text();
      $('[data-model-input]').val(modelInfo);
      $('#page-name').val(window.location.href);
    });
  }

  init();
});
</script>
