<script>
/**
 * NOTE: Add this script AFTER jQuery is loaded. 
 * If you're using an external file (e.g. vehicle_validation.html),
 * you can replace its contents entirely with this.
 */

// Make file uploads accept multiple files (if you want):
$("input[type=file]").attr("multiple", "multiple");

$(document).ready(function () {
  "use strict";

  //-----------------------------------------------------------------
  // 1. Hide all error messages & remove "error" classes initially
  //-----------------------------------------------------------------
  $('[wr-type="error"]').hide();
  $('[wr-type="required-field"]').removeClass("error");

  let formErrors = false;

  //-----------------------------------------------------------------
  // Utility to show an error on a single field (and set formErrors)
  //-----------------------------------------------------------------
  const fieldError = function ($field) {
    $field.siblings('[wr-type="error"]').show();
    $field.addClass("error");
    formErrors = true;
  };

  //-----------------------------------------------------------------
  // Utility to clear error for a single field
  //-----------------------------------------------------------------
  const clearFieldError = function ($field) {
    $field.removeClass("error");
    $field.siblings('[wr-type="error"]').hide();
    // Because we might have multiple errors, setting formErrors=false
    // does not always guarantee the form is error-free. 
    // But we'll keep the same logic from your original scripts:
    formErrors = false;
  };

  //-----------------------------------------------------------------
  // Final Submission Button: checks all wr-type="required-field"
  //-----------------------------------------------------------------
  $('[wr-type="submit"]').on("click", function (e) {
    formErrors = false; // reset before checking

    // Validate all "required-field" elements
    $('[wr-type="required-field"]').each(function () {
      const $this = $(this);
      const val = $this.val();

      // 1) Empty check
      if (!val) {
        fieldError($this);
        return;
      }

      // 2) If it's an email field, check minimal '@' + '.'
      if (
        $this.attr("type") === "email" &&
        (val.indexOf("@") === -1 || val.indexOf(".") === -1)
      ) {
        fieldError($this);
        return;
      }
    });

    // If no errors, submit the form
    if (!formErrors) {
      $(this).closest("form").submit();
    }
  });

  //-----------------------------------------------------------------
  // Clear error whenever user types or blurs a required field
  //-----------------------------------------------------------------
  $('[wr-type="required-field"]').on("keypress blur", function () {
    clearFieldError($(this));
  });

  //-----------------------------------------------------------------
  // Pressing ENTER triggers final form submission
  //-----------------------------------------------------------------
  $("input, textarea").on("keypress", function (e) {
    if (e.keyCode === 13) {
      e.preventDefault();
      $(this).trigger("change");
      $('[wr-type="submit"]').click();
    }
  });

  //-----------------------------------------------------------------
  // The main Rent Form (multi-step slider)
  //-----------------------------------------------------------------
  const rentForm = document.getElementById("wf-form-Rent-Form");

  //-----------------------------------------------------------------
  // STEP 1: #slider-1 => Validate the "dates" (Pick Up & Drop Off)
  //-----------------------------------------------------------------
  const getStartedBtn = document.getElementById("slider-1");
  const datesField = $("#dates"); // <input id="dates">

  if (getStartedBtn) {
    getStartedBtn.addEventListener("click", function (e) {
      if (!datesField.val()) {
        e.preventDefault();
        e.stopPropagation();
        fieldError(datesField);
      }
    }, true);
  }

  //-----------------------------------------------------------------
  // STEP 2: #slider-2 => "With Driver" vs "Self Drive" 
  // Must validate the correct license file inputs
  //-----------------------------------------------------------------
  const nextStepBtn2 = document.getElementById("slider-2");
  const withDriver = document.getElementById("with-driver");
  const selfDrive = document.getElementById("self-drive");

  // The real file inputs for license
  const licenseFrontInput = document.getElementById("Driving-License---Front");
  const licenseBackInput  = document.getElementById("Driving-License---Back");

  // Default: auto-check "With Driver"
  if (withDriver) {
    withDriver.checked = false;
    withDriver.click(); 
  }

  if (nextStepBtn2) {
    nextStepBtn2.addEventListener("click", function (e) {
      // Must select at least one: withDriver OR selfDrive
      if (!withDriver.checked && !selfDrive.checked) {
        e.preventDefault();
        e.stopPropagation();
        fieldError($("#with-driver"));
        fieldError($("#self-drive"));
        return;
      }

      // If Self Drive is chosen => both license uploads required
      if (selfDrive.checked) {
        if (licenseFrontInput.files.length === 0) {
          e.preventDefault();
          e.stopPropagation();
          fieldError($("#Driving-License---Front"));
          return;
        }
        if (licenseBackInput.files.length === 0) {
          e.preventDefault();
          e.stopPropagation();
          fieldError($("#Driving-License---Back"));
          return;
        }
      }
    }, true);
  }

  // Remove errors if user toggles driver checkboxes
  function removeDriverErrors() {
    if (withDriver.checked || selfDrive.checked) {
      clearFieldError($("#with-driver"));
      clearFieldError($("#self-drive"));
    }
  }
  withDriver?.addEventListener("change", removeDriverErrors);
  selfDrive?.addEventListener("change", removeDriverErrors);

  //-----------------------------------------------------------------
  // STEP 3: #slider-3 => "Airport Pickup" optional fields
  // If #airport-pickup is checked => flight number/time required
  //-----------------------------------------------------------------
  const nextStepBtn3 = document.getElementById("slider-3");
  const airportPickup = document.getElementById("airport-pickup");
  const flightNumber  = $("#flight-number");
  const flightTime    = $("#flight-time");
  const pickUpField   = $("#pick-up-drop-off-date");

  if (nextStepBtn3) {
    nextStepBtn3.addEventListener("click", function (e) {
      if (airportPickup && airportPickup.checked) {
        if (!flightNumber.val()) {
          e.preventDefault();
          e.stopPropagation();
          fieldError(flightNumber);
        }
        if (!flightTime.val()) {
          e.preventDefault();
          e.stopPropagation();
          fieldError(flightTime);
        }
        if (!pickUpField.val()) {
          e.preventDefault();
          e.stopPropagation();
          fieldError(pickUpField);
        }
      }
    }, true);
  }

  //-----------------------------------------------------------------
  // STEP 4: Next button has class ".slider-right" in the 4th slide
  // If #Out-Of-Accra is checked => must select at least one region
  //-----------------------------------------------------------------
  const outOfAccra = document.getElementById("Out-Of-Accra");
  // This button is the "Next Step" link on the 4th slide:
  const slide4NextBtn = document.querySelector(".slide:nth-child(4) .slider-right.w-button");
  const allRegionBoxes = document.querySelectorAll(
    '#location-details input[type="checkbox"]'
  );
  
  // Notice in the HTML, #Out-Of-Accra had required="" â€“ remove that
  outOfAccra?.removeAttribute("required");

  if (slide4NextBtn) {
    slide4NextBtn.addEventListener("click", function (e) {
      if (outOfAccra && outOfAccra.checked) {
        let regionSelected = false;
        allRegionBoxes.forEach((box) => {
          if (box.checked) {
            regionSelected = true;
          }
        });

        if (!regionSelected) {
          e.preventDefault();
          e.stopPropagation();
          // If you want to show an error message, 
          // you could do something like:
          // fieldError($("#Outside-Accra-Locations"));
        }
      }
    }, true);
  }

  //-----------------------------------------------------------------
  // STEP 5 (Last Step): "ID Upload" => #Passport-Pic---Front & #Passport-Pic---Back
  // The final submission also checks them because we set wr-type="required-field"
  // But if you want an immediate check on step 5's "Next" button, do below:
  //-----------------------------------------------------------------
  const idFrontInput = document.getElementById("Passport-Pic---Front");
  const idBackInput  = document.getElementById("Passport-Pic---Back");

  // If you have a separate "Next" or "Book Now" button on step 5, 
  // give it an ID and do something like:
  const step5NextBtn = document.getElementById("slider-5"); 
  // (But from your markup, the last step has <input type="submit" class="slider-button-submit">)

  if (step5NextBtn) {
    step5NextBtn.addEventListener("click", function (e) {
      // Check each ID field separately
      if (idFrontInput.files.length === 0) {
        e.preventDefault();
        e.stopPropagation();
        fieldError($("#Passport-Pic---Front"));
      }
      if (idBackInput.files.length === 0) {
        e.preventDefault();
        e.stopPropagation();
        fieldError($("#Passport-Pic---Back"));
      }
    }, true);
  }

  // If you want the final "Book Now" (the actual submit) to do separate checks:
  // keep wr-type="required-field" on each input, so each shows an error if empty.

});
</script>
     
<!-- If you use Webflow push for show/hide, keep that code as is. -->
<script>
  var Webflow = Webflow || [];
  Webflow.push(function () {
    // Show/hide details logic
    var checkboxLocation = document.getElementById("Out-Of-Accra");
    var checkboxLicense = document.getElementById("self-drive");
    var checkboxPickup = document.getElementById("airport-pickup");
    var locationDetails = document.getElementById("location-details");
    var licenseDetails = document.getElementById("license-details");
    var airportDetails = document.getElementById("airportpick-details");

    locationDetails.style.display = "none";
    licenseDetails.style.display = "none";
    airportDetails.style.display = "none";

    checkboxLocation.addEventListener("click", function () {
      locationDetails.style.display = checkboxLocation.checked ? "block" : "none";
    });

    checkboxLicense.addEventListener("click", function () {
      licenseDetails.style.display = checkboxLicense.checked ? "block" : "none";
    });

    checkboxPickup.addEventListener("click", function () {
      airportDetails.style.display = checkboxPickup.checked ? "block" : "none";
    });
  });
</script>

<!-- Search Feature remains the same -->
<script>
  $(".on-page-search").on("keyup", function () {
    var v = $(this).val();
    $(".results").removeClass("results");
    $(".noresults").removeClass("noresults");

    $(".search-result").each(function () {
      var $this = $(this);
      if (v !== "" && $this.text().search(new RegExp(v, "gi")) !== -1) {
        $this.addClass("results");
      } else if (v !== "" && $this.text().search(v) !== 1) {
        $this.addClass("noresults");
      }
    });
  });
</script>

<script>
  // On window load, fill hidden fields with vehicle model/page URL
  window.addEventListener("load", function () {
    const model = document.getElementById("make");
    const carName = document.getElementById("car-name");

    const modelInput1 = document.getElementById("Vehicle-Model-Number");
    const modelInput2 = document.getElementById("Vehicle-Model-Number-2");
    const modelInput3 = document.getElementById("Vehicle-Model-Number-3");
    const modelInput4 = document.getElementById("Vehicle-Model-Number-4");
    const pageNameInput = document.getElementById("page-name");

    const modelInfo = model.textContent + " " + carName.textContent;

    modelInput1.value = modelInfo;
    modelInput2.value = modelInfo;
    modelInput3.value = modelInfo;
    modelInput4.value = modelInfo;

    pageNameInput.value = window.location.href;
  });
</script>
